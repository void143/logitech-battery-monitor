name: Build MSI Installer

on:
  push:
    tags:
      - "v*"          # trigger on version tags like v1.0.0
  workflow_dispatch:  # allow manual trigger from GitHub Actions UI

permissions:
  contents: write   # required to create GitHub Releases

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: pip install -r requirements.txt pyinstaller

      - name: Install WiX
        run: |
          dotnet tool install --global wix
          cd installer
          wix extension add WixToolset.UI.wixext/6.0.2

      - name: Read version
        id: version
        shell: pwsh
        run: |
          $ver = (Select-String -Path monitor.py -Pattern '^APP_VERSION\s*=\s*"(.+)"').Matches[0].Groups[1].Value
          echo "APP_VERSION=$ver" >> $env:GITHUB_ENV
          echo "MSI_NAME=LogitechBatteryMonitor-$ver-x64.msi" >> $env:GITHUB_ENV

      - name: Generate icon.ico
        run: python installer/make_icon.py

      - name: Build executable (PyInstaller)
        run: pyinstaller installer/monitor.spec --distpath dist --workpath build --noconfirm

      - name: Build MSI (WiX)
        run: |
          cd installer
          wix build package.wxs -o ../dist/${{ env.MSI_NAME }} -ext WixToolset.UI.wixext

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: msi-installer
          path: dist/${{ env.MSI_NAME }}

      - name: Create GitHub Release and attach MSI
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ env.MSI_NAME }}
          body: |
            ## Installation

            1. Download `${{ env.MSI_NAME }}` below
            2. Run it â€” no Python required
            3. The app starts automatically and appears in your system tray

            ## What's new
            <!-- add release notes here -->
